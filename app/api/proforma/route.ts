const { default: PDFDocument } = await import('pdfkit');
const { Resend } = await import('resend');
export const runtime = 'nodejs';
import { NextRequest } from 'next/server';import { findPriceForSKU } from '@/lib/catalog';import createOrderInAirtable from '@/lib/orders';export async function POST(req: NextRequest){const body=await req.json().catch(()=>({}));const rfq={company:body.company||'',email:body.email||'',whatsapp:body.whatsapp||'',forwarder:body.forwarder||'',forwarderAddr:body.forwarderAddr||'',forwarderContact:body.forwarderContact||'',items:Array.isArray(body.items)?body.items:[],};const t=new Date();const yyyy=t.getFullYear();const mm=String(t.getMonth()+1).padStart(2,'0');const dd=String(t.getDate()).padStart(2,'0');const orderNo=`NT-${yyyy}${mm}${dd}-`+Math.floor(100+Math.random()*900);const doc=new PDFDocument({size:'LETTER',margin:36});const chunks=[];doc.on('data',(c)=>chunks.push(c));const done=new Promise(resolve=>doc.on('end',()=>resolve(Buffer.concat(chunks))));doc.fontSize(18).text('PRO FORMA INVOICE');doc.moveDown(.5);doc.fontSize(10).text(`Date: ${yyyy}-${mm}-${dd}`);doc.text(`Pro Forma No.: ${orderNo}`);doc.moveDown();doc.fontSize(11).text('Seller:',{underline:true});doc.fontSize(10).text('Nexo Tech (E & R EXPORTS & DISTRIBUTION, LLC)');doc.text('2114 N Flamingo Road #627, Pembroke Pines, FL 33028');doc.text('Email: erdistributions@gmail.com   Phone/WhatsApp: 754-207-5750');doc.moveDown();doc.fontSize(11).text('Buyer:',{underline:true});doc.fontSize(10).text(rfq.company);doc.text(`Email: ${rfq.email}    WhatsApp: ${rfq.whatsapp}`);doc.moveDown();doc.fontSize(11).text('Terms:',{underline:true});doc.fontSize(10).text('Incoterm: FCA Miami — Buyer’s freight forwarder');doc.text(`Delivery Location: ${rfq.forwarder} — ${rfq.forwarderAddr}`);doc.text(`Forwarder Contact: ${rfq.forwarderContact}`);doc.moveDown();doc.fontSize(11).text('Bank / Wire Instructions:',{underline:true});doc.fontSize(10).text('Beneficiary: E&R Distributions');doc.text('Bank: NBKC');doc.text('Account: 8229873   •   SWIFT/BIC: KAASUS41');doc.text('Reference: Order #');doc.moveDown();doc.fontSize(11).text('Line Items:',{underline:true});doc.moveDown(.5);const headerY=doc.y;doc.fontSize(10).text('SKU',36,headerY,{width:160});doc.text('Qty',200,headerY,{width:80});doc.text('Unit Price (USD)',260,headerY,{width:120});doc.text('Line Total (USD)',380,headerY,{width:160});doc.moveDown(.5);let subtotal=0;for(const it of rfq.items){const sku=String(it.sku||'');const qty=Number(it.qty||1);const unitPrice=await findPriceForSKU(sku);const lineTotal=unitPrice*qty;subtotal+=lineTotal;doc.text(sku,36);doc.text(String(qty),200);doc.text(unitPrice.toFixed(2),260);doc.text(lineTotal.toFixed(2),380);}doc.moveDown();doc.text(`Subtotal (USD): ${subtotal.toFixed(2)}`);doc.text('Estimated Shipping: Buyer-arranged (not included)');doc.text(`TOTAL (USD): ${subtotal.toFixed(2)}`);doc.moveDown();doc.fontSize(10).text('Notes:');doc.text('- Prices based on FCA Miami; buyer arranges freight/insurance/customs.');doc.text('- Units tested and data-wiped to NIST 800-88.');doc.text('- Pro forma valid for 7 days.');doc.text('- Ownership and risk transfer at delivery to buyer’s forwarder in Miami.');doc.end();const buffer=await done;try{const resend=new Resend(process.env.RESEND_API_KEY as string);const from=process.env.MAIL_FROM||'no-reply@nexotech.us';const to=[rfq.email].concat(process.env.MAIL_TO?[process.env.MAIL_TO]:[]);await resend.emails.send({from,to,subject:`Pro Forma Invoice ${orderNo}`,html:`<p>Dear ${rfq.company||'Buyer'},</p><p>Attached is your pro forma invoice <b>${orderNo}</b> with FCA Miami terms and wire instructions.</p><p>Beneficiary: E&R Distributions • Bank: NBKC • Acct: 8229873 • SWIFT/BIC: KAASUS41 • Reference: Order #</p><p>Best regards,<br/>Nexo Tech</p>`,attachments:[{filename:`Pro-Forma-${orderNo}.pdf`,content:buffer.toString('base64')}],});}catch(e){}createOrderInAirtable(orderNo,rfq).catch(()=>{});return new Response(buffer,{headers:{'Content-Type':'application/pdf','Content-Disposition':'attachment; filename="Pro-Forma-Invoice.pdf"','X-Order-No':orderNo}});}
